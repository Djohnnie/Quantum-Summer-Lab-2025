@using MediatR
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using QuantumSummerLab.Application.Scores.Queries
@using QuantumSummerLab.Application.Teams.Commands

@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStore
@inject IMediator Mediator

@page "/leaderboard"

<PageTitle>Quantum Summer Lab - Leaderboard</PageTitle>

@if (Entries is not null)
{
    <MudCard Elevation="5" Class="mt-6">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Leaderboard</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudTable Items="@Entries" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh Style="width: 100px;">Position</MudTh>
                <MudTh>Team</MudTh>
                <MudTh Style="width: 150px;">Score</MudTh>
                <MudTh>Comments</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Position">
                    <MudChip T="string" Color="Color.Primary">@context.Position</MudChip>
                </MudTd>
                <MudTd DataLabel="Team"><strong>@context.TeamName</strong></MudTd>
                <MudTd DataLabel="Score">
                    <MudChip T="string" Color="@(context.TotalPoints > 0 ? Color.Success : Color.Warning)">@context.TotalPoints points</MudChip>
                </MudTd>
                <MudTd DataLabel="Comments">@context.Description</MudTd>
            </RowTemplate>
        </MudTable>
    </MudCard>
}
else
{
    <MudText Typo="Typo.h6" Class="mt-6">Loading leaderboard...</MudText>
}

@code {

    private int currentCount = 0;

    private bool IsLoggedIn { get; set; }

    private List<LeaderboardEntry> Entries { get; set; }
    private string SearchString = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            IsLoggedIn = (await ProtectedLocalStore.GetAsync<AuthenticationToken>("authToken")).Success;
            var result = await Mediator.Send(new GetLeaderboardQuery());
            Entries = result.Entries;

            StateHasChanged();
        }
    }

    private bool FilterFunc(LeaderboardEntry element) => Filter(element, SearchString);

    private bool Filter(LeaderboardEntry entry, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (entry.TeamName.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }
}